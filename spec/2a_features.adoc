[[features]]
=== 要素

[[sfsql_intro]]
==== 简单要素的SQL访问介绍  

矢量要素数据表达具有地理位置信息的地物，包括类似行政区划的概念对象，诸如道路、河流的现实对象，以及它们包含的具体信息。
在通过关系型数据库的SQL语句存储、访问和使用地理空间要素/几何对象方面，已经有许多国际标准<<9>><<10>><<11>><<12>> 。
在GeoPackage文件中，表`gpkg_spatial_ref_sys`是SQL schema中描述矢量要素的第一个部分，参见<<spatial_ref_sys>>一节。
SQL schema中描述矢量要素的其他部分定义如下。

GeoPackage中，“简单”要素是通过 SQL/MM (ISO 13249-3) <<12>>几何模型中的线性几何子集来表达的，如下图 <<core_geometry_model_figure>> 所示。

[[core_geometry_model_figure]]
.核心几何模型
image::core-geometry-model.png[Core geometry model]

这个标准对具体的（非抽象的）几何对象类型做了限制，必须为2，3或4维坐标空间（R2，R3和R4）中的0，1或2维二维对象。
R2中的几何对象的点拥有x和y坐标。
R3中的几何对象的点拥有x、y、z坐标，或x、y、m坐标。
R4中的几何对象的点拥有x、y、z和m坐标。
真实坐标由点所属的坐标系决定。
几何对象中的所有点应该属于同一个坐标系。

几何对象可能拥有z坐标值。
z表示三维（例如，3D）。
在地理信息系统（GIS）中，通常是指海拔高度。
例如，在地图中可以使用x、y值来表示一座山峰在地球上的位置，使用z值来表示这座山峰的高度。

几何对象可能拥有m坐标值。
m值在实际应用中，表示与参考点的距离。
例如，一个水系网可以被表示为具有m坐标的多线性值，m值表示当前位置距水源头的距离。

根据本标准中几何类型的定义，所有的几何对象都必须是拓扑闭合的，例如，所有的几何对象都有拓扑边界，边界用点集合表示。这并不影响它们的表达，在其他应用场景下（例如拓扑展现），可以使用同样类型的开放版本。

每种几何类型的简要说明如下，
更详细的说明可参见ISO 13249-3 <<12>>。
* Geometry: 几何类型继承关系的根。
* Point: 点，空间中的一个位置。每个点都有一个X和Y坐标值，有些点还可能Z和（或）M值。
* Curve: 曲线，所有1维几何类型的基本类型。1维几何要素具有长度但没有面积。
curve如果不与自身相交（在起点和终点除外），则认为它是简单曲线。
如果curve的起点和终点重合，则认为它是闭合曲线。
一个简单、闭合的curve（曲线）被称为环（ring）。
* LineString: 连接两个或多个点的曲线。
* Surface: 面，所有2维几何类型的基本类型，2维几何类型具有面积。
* CurvePolygon: 由一个外环、零个或多个内环构成的曲面，每个环都是曲线（Curve）类型的。
* Polygon: 当CurvePolygon中的每个环都是简单、闭合的LineString类型时，它被称为Polygon。
* GeometryCollection: 零个或多个几何对象的集合。
* MultiSurface: GeometryCollection中的每个几何对象都是Surface类型时，它被称为MultiSurface。
* MultiPolygon: GeometryCollection中的每个几何对象都是Polygon类型时，它被称为MultiPolygon。
* MultiCurve: GeometryCollection中的每个几何对象都是Curve类型时，它被称为MultiCurve。
* MultiLineString: GeometryCollection中的每个几何对象都是LineString类型时，它被称为MultiLineString。
* MultiPoint: GeometryCollection中的每个几何对象都是Point类型时，它被称为MultiPoint。

==== 内容

===== 数据

====== 表内容 – 要素行

[requirement]
The `gpkg_contents` table SHALL contain a row with a lowercase `data_type` column value of “features” for each vector features user data table or view.   用户数据表或视图中的每个矢量要素都应该包括值为小写“features”的列。
[[gpb_format]]
==== 几何编码

===== 数据

[[gpb_data_blob_format]]
====== BLOB 格式

[requirement]
A GeoPackage SHALL store feature table geometries with or without optional elevation (Z) and/or measure (M) values in SQL BLOBs using the Standard GeoPackageBinary format specified in table <<gpb_spec>> and clause <<gpb_data_blob_format>>.
按GeoPackage 规范存储在SQL 数据库中的数据，应该包括有或没有可选的海拔（Z）和/或测量（M）的值的几何要素表，这些值使用的是表<<gpb_spec>>和条款<<gpb_data_blob_format>>中指定的StandardGeoPackageBinary格式。
:geopackage_binary_foot1: footnote:[OGC WKB simple feature geometry types specified in <<13>> are a subset of the ISO WKB geometry types specified in <<16>>]
:geopackage_binary_foot2: footnote:[WKB geometry types are are restricted to 0, 1 and 2-dimensional geometric objects that exist in 2, 3 or 4-dimensional coordinate space; they are not geographic or geodesic geometry types.]
:geopackage_binary_foot3: footnote:[The axis order in WKB is always (x,y{,z}{,m}) where x is easting or longitude, y is northing or latitude, z is optional elevation and m is optional measure.]

.GeoPackage SQL Geometry Binary Format
[[gpb_spec]]
----
GeoPackageBinaryHeader {
  byte[2] magic = 0x4750; <1>
  byte version;           <2>
  byte flags;             <3>
  int32 srs_id;
  double[] envelope;      <4>
}

StandardGeoPackageBinary {
  GeoPackageBinaryHeader header; <5>
  WKBGeometry geometry;          <6>
}
----

<1> 'GP' in ASCII
<2> 8-bit unsigned integer, 0 = version 1
<3> see <<flags_layout>>
<4> see flags envelope contents indicator code below  见下面的标志信封内容的指标代码
<5> The X bit in the header flags field must be set to 0.
<6> per  ISO 13249-3 <<12>> clause 5.1.46 {geopackage_binary_foot1}{geopackage_binary_foot2}{geopackage_binary_foot3}

[[flags_layout]]
.bit layout of GeoPackageBinary flags byte
[cols=",,,,,,,,",]
|===========================
|bit |7 |6 |5 |4 |3 |2| 1| 0
|use |R |R |X |Y |E |E| E| B
|===========================

*flag bits use:*

* R: reserved for future use; set to 0  保留供将来使用;设置为0
* X: GeoPackageBinary type
** 0: StandardGeoPackageBinary. See below
** 1: ExtendedGeoPackageBinary. See <<extension_geometry_encoding>>.
* Y: empty geometry flag
** 0: non-empty geometry
** 1: empty geometry
* E: envelope contents indicator code (3-bit unsigned integer)
** 0: no envelope (space saving slower indexing option), 0 bytes
** 1: envelope is [minx, maxx, miny, maxy], 32 bytes
** 2: envelope is [minx, maxx, miny, maxy, minz, maxz], 48 bytes
** 3: envelope is [minx, maxx, miny, maxy, minm, maxm], 48 bytes
** 4: envelope is [minx, maxx, miny, maxy, minz, maxz, minm, maxm], 64 bytes
** 5-7: invalid
* B: byte order for header values (1-bit Boolean)
** 0: Big Endian (most significant byte first)
** 1: Little Endian (least significant byte first)


Well-Known Binary as defined in ISO 13249-3 <<12>> does not provide a standardized encoding for an empty point set (i.e., 'Point Empty' in Well-Known Text).
In GeoPackages these points SHALL be encoded as a Point where each coordinate value is set to an IEEE-754 quiet NaN value.
GeoPackages SHALL use big endian 0x7ff8000000000000 or little endian 0x000000000000f87f as the binary encoding of the NaN values. 
熟知用ISO 13249-3 <<12>> 定义的二进制没有为空的点集提供标准的编码（即用熟知文本的“空点”）。使用GeoPackages协议的这些点应该被编码为一个点，这个点的坐标值被设置为一个IEEE-754静态的NaN值。geopackages应使用大端口为0x7ff8000000000000或小端口为0x000000000000f87f的字节序列，作为NaN值的二进制编码。

When the WKBGeometry in a GeoPackageBinary is empty, either the envelope contents indicator code SHALL be 0 indicating no envelope, or the envelope SHALL have its values set to NaN as defined for an empty point.
当GeoPackageBinary的WKBGeometry值为空时，要么信封内容的指标代码为0，表示无信封，要么信封的值设置为NaN，定义为空点。

[[sql_geometry_types]]
==== SQL几何类型

===== 数据

====== 核心类型

[requirement] 
A GeoPackage SHALL store feature table geometries with the basic simple feature geometry types (Geometry, Point, LineString, Polygon, MultiPoint, MultiLineString, MultiPolygon, GeomCollection) in <<geometry_types>> <<geometry_types_core>> in the GeoPackageBinary geometry encoding format.
按GeoPackage规范，SQL数据库中应该存储有具有简单几何要素类型（几何，点，线，多边形，多点，multilinestring，multipolygon，geomcollection）的几何要素表，在附表<<geometry_types>> 和<<geometry_types_core>> 中使用了GeoPackageBinary几何编码格式。

==== 几何要素列

===== 数据 

====== 表定义

[requirement]
A GeoPackage with a `gpkg_contents` table row with a “features” `data_type` SHALL contain a `gpkg_geometry_columns` table or updateable view per <<gpkg_geometry_columns_cols>> and <<gpkg_geometry_columns_sql>>.
GeoPackage 包含一个`gpkg_contents` 表，表的每一行都是一个要素，`data_type`应该包括一个`gpkg_geometry_columns`表或更新视图的<<gpkg_geometry_columns_cols>> 和<<gpkg_geometry_columns_sql>>。

The second component of the SQL schema for vector features in a GeoPackage is a `gpkg_geometry_columns` table that
identifies the geometry columns in tables that contain user data representing features.
按geopackage规范存储矢量要素的SQL框架的第二个组成部分是`gpkg_geometry_columns`表，这个表用于标识包含用户数据的几何要素列。


[[gpkg_geometry_columns_cols]]
.Geometry Columns Table or View Definition
[cols=",,,",options="header",]
|=======================================================================
|Column Name |Type |Description |Key
|`table_name` |TEXT |Name of the table containing the geometry column 包含几何要素列的表名 |PK, FK
|`column_name` |TEXT |Name of a column in the feature table that is a Geometry Column 要素表中的列名，代表的是一个几何要素列|PK
|`geometry_type_name` |TEXT |Name from <<geometry_types_core>> or <<geometry_types_extension>> in <<geometry_types>> |
|`srs_id` |INTEGER |空间参考系统 ID: `gpkg_spatial_ref_sys.srs_id` |FK
|`z` |TINYINT |0: z values prohibited; 1: z values mandatory; 2: z values optional  0：禁止z值; 1：z值的强制性; 2：z值可选|
|`m` |TINYINT |0: m values prohibited; 1: m values mandatory; 2: m values optional  0：禁止m值; 1：m值的强制性; 2：m值可选|
|=======================================================================

The FK on `gpkg_geometry_columns.srs_id` references the PK on `gpkg_spatial_ref_sys.srs_id` to ensure that geometry columns are only defined in feature tables for defined spatial reference systems.
在gpkg_geometry_columns.srs_id上的FK引用gpkg_spatial_ref_sys.srs_id上的PK，以确保几何列仅在定义空间参考系的要素表中定义。

Views of this table or view MAY be used to provide compatibility with the SQL/MM <<12>> <<sqlmm_gpkg_geometry_columns_sql>> and OGC Simple Features SQL <<9>><<10>><<11>> <<sfsql_gpkg_geometry_columns_sql>> specifications.
此表或视图的视图可以被用来提供SQL/ MM<<12>> <<sqlmm_gpkg_geometry_columns_sql>>和OGC简单要素<<9>><<10>><<11>> <<sfsql_gpkg_geometry_columns_sql>> 规范的兼容性。 

See <<gpkg_geometry_columns_sql>>.

====== 表数据值
[requirement]
The `gpkg_geometry_columns` table or updateable view SHALL contain one row record for the geometry column in each vector feature data table (clause <<feature_user_tables>>) in a GeoPackage.
该gpkg_geometry_columns表或可更新视图应包含一行记录，该记录针对符合GeoPackage 规范的每个矢量要素用户表的几何列。

[requirement]
Values of the `gpkg_geometry_columns` `table_name` column SHALL reference values in the `gpkg_contents` `table_name` column for rows with a `data_type` of 'features'.
`gpkg_geometry_columns` 和`table_name` 列的值应该参考`gpkg_contents` `table_name` 列的值 。

[requirement]
The `column_name` column value in a `gpkg_geometry_columns` row SHALL be the name of a column in the table or view specified by the `table_name` column value for that row.
`gpkg_geometry_columns` 行的`column_name` 列的值是通过该行`table_name` 列的值指定的表或视图的列名。

[requirement]
The `geometry_type_name` value in a `gpkg_geometry_columns` row SHALL be one of the uppercase geometry type names specified in <<geometry_types>>.  `gpkg_geometry_columns` 行的`geometry_type_name` 的值应该是附录<<geometry_types>>中大写的几何类型名字之一。

[requirement]
The `srs_id` value in a `gpkg_geometry_columns` table row SHALL be an `srs_id` column value from the `gpkg_spatial_ref_sys` table.
在`gpkg_geometry_columns`表行的srs_id值应为`gpkg_spatial_ref_sys`表中`srs_id` 列值。

[requirement]
The z value in a `gpkg_geometry_columns` table row SHALL be one of 0, 1, or 2.  `gpkg_geometry_columns`表行的Z值应该是0, 1或2之一。 

[requirement]
The m value in a `gpkg_geometry_columns` table row SHALL be one of 0, 1, or 2.   `gpkg_geometry_columns`表行的m值应该是0, 1或2之一。

[[feature_user_tables]]
==== 矢量要素用户数据表

===== 数据

======表定义

:features_data_table_foot2: footnote:[A GeoPackage is not required to contain any feature data tables. Feature data tables in a GeoPackage MAY be empty.]

The third component of the SQL schema for vector features in a GeoPackage described in clause <<sfsql_intro>> above are tables that contain user data representing features.
Feature attributes are columns in a feature table, including geometries.
Features are rows in a feature table.
{features_data_table_foot2}
按上面<<sfsql_intro>>条款中描述的geopackage规范，存储矢量要素的SQL框架的第三个组成部分是包含表示功能的用户数据表。要素属性对应要素表中的列，包括几何要素。要素对应于要素表{features_data_table_foot2}的行。

[[requirement_feature_integer_pk]]
[requirement]
A GeoPackage MAY contain tables or updateable views containing vector features.
Every such feature table or view in a GeoPackage SHALL have a column with column type INTEGER and 'PRIMARY KEY AUTOINCREMENT' column constraints per <<example_feature_table_cols>> and <<example_feature_table_sql>>.
geopackage规范包含表或含有矢量要素的可更新视图。符合GeoPackage规范的每个要素表或视图都应该有一个INTEGER类型的列和'PRIMARY KEY AUTOINCREMENT'类型的约束列，在<<example_feature_table_cols>>和<<example_feature_table_sql>>中有描述。

The integer primary key of a feature table allows features to be linked to row level metadata records in the `gpkg_metadata` table by rowid <<B5>> values in the `gpkg_metadata_reference` table as described in clause <<_metadata_reference_table>> below.
要素表的整形主键约束允许要素通过`gpkg_metadata_reference` 表的 <<B5>> 值与`gpkg_metadata`表的行级元素据关联，具体的在下面<<_metadata_reference_table>>表中进行了描述。

[requirement]
A feature table SHALL have only one geometry column.
要素表应该仅仅有一个几何要素列。

Feature data models <<B23>> from non-GeoPackage implementations that have multiple geometry columns per feature table MAY be transformed into GeoPackage implementations with a separate feature table for each geometry type whose rows have matching integer primary key values that allow them to be joined in a view with the same column definitions as the non-GeoPackage feature data model with multiple geometry columns.
按非geopackage规范实现的要素数据模型 <<B23>>每个要素表可以有多个几何要素列，这种表可以转换为规范的表。。。。。。。

[[example_feature_table_cols]]
.EXAMPLE : Sample Feature Table or View Definition
[cols=",,,,,",options="header"]
|=======================================================================
|Column Name |Type |Description |Null |Default |Key
|`id` |INTEGER |Autoincrement primary key 自动增量主键|no | |PK
|`geometry` |GEOMETRY |GeoPackage Geometry 符合GeoPackage规范的几何要素 |yes | |
|`text_attribute` |TEXT |Text attribute of feature 要素文本属性 |yes | |
|`real_attribute` |REAL |Real attribute of feature 要素纯文本属性|yes | |
|`boolean_attribute` |BOOLEAN |Boolean attribute of feature 要素布尔逻辑属性 |yes | |
|`raster_or_photo` |BLOB |Photograph of the area  区域图片|yes | |
|=======================================================================

See <<example_feature_table_sql>>.

====== 表数据值 

A feature geometry is stored in a geometry column specified by the lowercase `geometry_column` value for the feature table in the `gpkg_geometry_columns` table defined in clause <<_geometry_columns>> above.
几何要素以列的形式存储，这个列被上面<<_geometry_columns>> 条款中定义的`gpkg_geometry_columns`表中的值为小写的`geometry_column`列限定。

The geometry type of a feature geometry column specified in the `gpkg_geometry_columns` table `geometry_type_name` column is a name from <<geometry_types>>.
被表`gpkg_geometry_columns`中列名为`geometry_type_name` 限定的几何要素列类型，是<<geometry_types>>表中名字的一种形式。


:geom_type_req_foot1: footnote:[GeoPackage applications MAY use SQL triggers or tests in application code to meet this requirement]
[requirement]
Feature table geometry columns SHALL contain geometries of the type or assignable for the type specified for the column by the `gpkg_geometry_columns` table `geometry_type_name` uppercase column value {geom_type_req_foot1}.
几何要素列应该包含几何要素类型或由`gpkg_geometry_columns`表的`geometry_type_name`列的大写值指定的可分配类型。

Geometry subtypes are assignable as defined in <<geometry_types>> and shown in part in <<core_geometry_model_figure>>.   子几何类型可以被<<geometry_types>> 和<<core_geometry_model_figure>>中的类型指定。
For example, if the `geometry_type_name` value in the `gpkg_geometry_columns` table is for a geometry type like POINT that has no subtypes, then the feature table geometry column MAY only contain geometries of that type.
If the geometry `type_name` value in the `gpkg_geometry_columns` table is for a geometry type like GEOMCOLLECTION that has subtypes, then the feature table geometry column MAY only contain geometries of that type or any of its direct or indirect subtypes.
If the geometry `type_name` is GEOMETRY (the root of the geometry type hierarchy) then the feature table geometry column MAY contain geometries of any geometry type.
例如：如果表`gpkg_geometry_columns`中列 `geometry_type_name` 的值是一种几何类型，如POINT，POINT没有子类型，这种几何要素表的列可能只含有这种类型的几何要素。如果表`gpkg_geometry_columns` 中`type_name`的值是一种类似GEOMCOLLECTION的几何类型，则没有子类型，这种几何要素表的列只包含这种类型或是它的任何直接或间接子类型的几何要素。
如果几何要素的`type_name`值为GEOMETRY （几何类型层次结构的根），这种要素表的几何列可以包含任何几何类型的几何要素。

几何要素存在或不存在可选的高程（Z）和/或测量（M）值不会改变它的类型或可转让性。

The spatial reference system type of a feature geometry column specified by a `gpkg_geometry_columns` table `srs_id` column value is a code from the `gpkg_spatial_ref_sys` table `srs_id` column.
几何要素的空间参考系统类型是由`gpkg_geometry_columns` 表中的`srs_id`列的值限定的，`srs_id`的值是一种编码，来自表`gpkg_spatial_ref_sys` 的`srs_id`列。

[requirement]
Feature table geometry columns SHALL contain geometries with the `srs_id` specified for the column by the `gpkg_geometry_columns` table `srs_id` column value.
要素表的几何列应该包含被表`gpkg_geometry_columns`的 `srs_id` 列值指定的几何要素。
