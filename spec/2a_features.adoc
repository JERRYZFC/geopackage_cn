
=== 要素


==== SQL 简单要素介绍  

矢量要素数据表达具有地理位置信息的地物，包括类似行政区划的概念对象，诸如道路、河流的现实对象，以及它们包含的具体信息。
在通过关系型数据库的SQL语句存储、访问和使用地理空间要素/几何对象方面，已经有许多国际标准<<9>><<10>><<11>><<12>> 。
在GeoPackage文件中，表`gpkg_spatial_ref_sys`是SQL schema中描述矢量要素的第一个部分，参见<<spatial_ref_sys>>一节。
其他组成部分在下面进行了定义。
按geopackage 规范，简单要素使用SQL/ MM（ISO13249-3）几何模型的线性几何子集定位，几何模型如下图<<core_geometry_model_figure>>所示：
[[core_geometry_model_figure]]
.Core Geometry Model
image::core-geometry-model.png[Core geometry model]

这个标准对具体的（非抽象的）几何对象类型做了限制，必须为2，3或4维坐标空间（R2，R3和R4）中的0，1或2维二维对象。
R2中的几何对象的点拥有x和y坐标。
R3中的几何对象的点拥有x、y、z坐标，或x、y、m坐标。
R4中的几何对象的点拥有x、y、z和m坐标。
真实坐标由点所属的坐标系决定。
几何对象中的所有点应该属于同一个坐标系。
几何要素可包括z坐标值。Z坐标值传统上代表第三个维度（即3D）。
在地理信息系统（GIS）中，Z坐标值可能代表会高于或低于海平面的高度。
例如：在一幅地图上，
可能会用x和y标识一个山峰在地球上的位置，z表示山峰的高度。
几何要素可包括M的坐标值。m值在实际应用中，表示与参考点的距离。
例如，一个水系网可以被表示为具有m坐标的多线性值，m值表示当前位置距水源头的距离。
根据本标准中几何类型的定义，所有的几何对象都必须是拓扑闭合的，
例如，所有的几何对象都有拓扑边界，边界用点集合表示。这并不影响它们的表达，
在其他应用场景下（例如拓扑展现），可以使用同样类型的开放版本。

每种几何类型的简要说明如下，更详细的说明可在更详细的说明可参见ISO 13249-3 <<12>>。

* Geometry:  几何类型继承关系的根。
* Point:在空间中的一个位置。每个点都有一个X和Y坐标。点可以选择包含一个Z和/或M值。
* Curve:所有1维几何类型的基本类型。1维几何要素是有长度但没有面积的几何要素。
Curve如果不与自身相交（在起点和终点除外），则认为它是简单曲线。
当曲线的起点和终点重合，则认为它是闭合曲线。
一个简单、闭合的curve（曲线）被称为环（ring）。
* LineString: 在空间连接两个或多个点的曲线。
* Surface: 面，所有2维几何类型的基本类型，2维几何类型是一种具有面积的几何类型。
* CurvePolygon:由一个外环和零个或多个内环所组成的平面。每个环都是曲线（Curve）类型的。
* Polygon: 当CurvePolygon中的每个环都是简单、闭合的LineString类型时，它被称为Polygon。
* GeometryCollection: 零个或多个几何对象的集合。
* MultiSurface: GeometryCollection中的每个几何对象都是Surface类型时，它被称为MultiSurface。
* MultiPolygon: GeometryCollection中的每个几何对象都是Polygon类型时，它被称为MultiPolygon。
* MultiCurve: GeometryCollection中的每个几何对象都是Curve类型时，它被称为MultiCurve。
* MultiLineString: GeometryCollection中的每个几何对象都是LineString类型时，它被称为MultiLineString。
* MultiPoint: GeometryCollection中的每个几何对象都是Point类型时，它被称为MultiPoint。

==== 内容

===== 数据

====== 表内容 – 要素行

[requirement]
对于每个矢量要素用户数据表或视图  `gpkg_contents` 表必须有一行包含 列名为小写的 `data_type`  ，列值为 “features”与之对应。

==== 几何编码

===== 数据

[[gpb_data_blob_format]]
====== BLOB 格式

[requirement]

GeoPackage必须要在所有要素表中以SQL BLOBS 存储几何要素，这些几何要素可以有或没有可选的海拔（Z）和/或测量（M）的值，
SQL BLOBS使用的是表<<gpb_spec>>和条款<<gpb_data_blob_format>>中指定的StandardGeoPackageBinary格式。
:geopackage_binary_foot1: footnote:[OGC WKB simple feature geometry types specified in <<13>> are a subset of the ISO WKB geometry types specified in <<16>>]
:geopackage_binary_foot2: footnote:[WKB geometry types are are restricted to 0, 1 and 2-dimensional geometric objects that exist in 2, 3 or 4-dimensional coordinate space; they are not geographic or geodesic geometry types.]
:geopackage_binary_foot3: footnote:[The axis order in WKB is always (x,y{,z}{,m}) where x is easting or longitude, y is northing or latitude, z is optional elevation and m is optional measure.]

.GeoPackage SQL Geometry Binary Format
[[gpb_spec]]
----
GeoPackageBinaryHeader {
  byte[2] magic = 0x4750; <1>
  byte version;           <2>
  byte flags;             <3>
  int32 srs_id;
  double[] envelope;      <4>
}

StandardGeoPackageBinary {
  GeoPackageBinaryHeader header; <5>
  WKBGeometry geometry;          <6>
}
----

<1> 'GP' in ASCII
<2> 8-bit unsigned integer, 0 = version 1
<3> see <<flags_layout>>
<4> see flags envelope contents indicator code below  见下面的标志信封内容的指标代码
<5> The X bit in the header flags field must be set to 0.
<6> per  ISO 13249-3 <<12>> clause 5.1.46 {geopackage_binary_foot1}{geopackage_binary_foot2}{geopackage_binary_foot3}

[[flags_layout]]
.bit layout of GeoPackageBinary flags byte
[cols=",,,,,,,,",]
|===========================
|bit |7 |6 |5 |4 |3 |2| 1| 0
|use |R |R |X |Y |E |E| E| B
|===========================

*flag bits use:*

* R: reserved for future use; set to 0  保留供将来使用;设置为0
* X: GeoPackageBinary type
** 0: StandardGeoPackageBinary. See below
** 1: ExtendedGeoPackageBinary. See <<extension_geometry_encoding>>.
* Y: empty geometry flag
** 0: non-empty geometry
** 1: empty geometry
* E: envelope contents indicator code (3-bit unsigned integer)
** 0: no envelope (space saving slower indexing option), 0 bytes
** 1: envelope is [minx, maxx, miny, maxy], 32 bytes
** 2: envelope is [minx, maxx, miny, maxy, minz, maxz], 48 bytes
** 3: envelope is [minx, maxx, miny, maxy, minm, maxm], 48 bytes
** 4: envelope is [minx, maxx, miny, maxy, minz, maxz, minm, maxm], 64 bytes
** 5-7: invalid
* B: byte order for header values (1-bit Boolean)
** 0: Big Endian (most significant byte first)
** 1: Little Endian (least significant byte first)


熟知的ISO 13249-3 <<12>> 所定义的二进制没有为空的点集提供标准的编码（即用熟知文本的“空点”）。在GeoPackages中这些点必须被编码为一个点，
这个点的每个坐标值被设置为一个IEEE-754静态的NaN值。geopackages应使用大低字节序0x7ff8000000000000或小低字节序0x000000000000f87f
作为NaN值的二进制编码。

当GeoPackageBinary的WKBGeometry值为空时，要么最小外接矩形的内容的指标代码为0，代表最小外接矩形，要么最小外接矩形的值设置为NaN，代表没有点。

[[sql_geometry_types]]
==== SQL几何类型

===== 数据

====== 核心类型

[requirement] 
A GeoPackage SHALL store feature table geometries with the basic simple feature geometry types
 (Geometry, Point, LineString, Polygon, MultiPoint, MultiLineString, MultiPolygon, GeomCollection)
 in <<geometry_types>> <<geometry_types_core>> in the GeoPackageBinary geometry encoding format.
按GeoPackage规范，SQL数据库中应该在要素表中存储有具有简单几何要素类型（几何，点，线，多边形，多点，multilinestring，multipolygon，geomcollection）的
几何要素，几何要素类型在附表<<geometry_types>> 和<<geometry_types_core>> 中使用了GeoPackageBinary几何编码格式。

==== 几何要素列

===== 数据 

====== 表定义

[requirement]
包含一个`gpkg_contents` 表的GeoPackage ，并且表的每一行都有一个值为“feature”，列名为`data_type` ，这样的GeoPackage应该包括
一个`gpkg_geometry_columns`表或可更新视图的 按照 <<gpkg_geometry_columns_cols>> 和<<gpkg_geometry_columns_sql>>。

The second component of the SQL schema for vector features in a GeoPackage is a `gpkg_geometry_columns` table that
identifies the geometry columns in tables that contain user data representing features.
按geopackage规范存储矢量要素的SQL框架的第二个组成部分是`gpkg_geometry_columns`表，这个表用于标识 那些包含了以用户数据来表示要素的表 中的几何要素列。


[[gpkg_geometry_columns_cols]]
.Geometry Columns Table or View Definition
[cols=",,,",options="header",]
|=======================================================================
|Column Name |Type |Description |Key
|`table_name` |TEXT | 包含几何要素列的表名 |PK, FK
|`column_name` |TEXT | 要素表中的列名，是一个几何要素列|PK
|`geometry_type_name` |TEXT |Name from <<geometry_types_core>> or <<geometry_types_extension>> in <<geometry_types>> |
|`srs_id` |INTEGER |空间参考系统 ID: `gpkg_spatial_ref_sys.srs_id` |FK
|`z` |TINYINT |  0：禁止z值; 1：z值必须有; 2：z值可选|
|`m` |TINYINT |  0：禁止m值; 1：m值必须有; 2：m值可选|
|=======================================================================

在 `gpkg_geometry_columns.srs_id` 上的FK references `gpkg_spatial_ref_sys.srs_id` 上的PK，以确保几何列仅在定义空间参考系的要素表中定义。

上面定义可以是表或视图，它的视图可以被用来兼容SQL/ MM<<12>> <<sqlmm_gpkg_geometry_columns_sql>>和OGC简单要素SQL<<9>><<10>><<11>> <<sfsql_gpkg_geometry_columns_sql>> 
规范。 

See <<gpkg_geometry_columns_sql>>.

====== 表数据值
[requirement]
该gpkg_geometry_columns表或可更新视图应 对GeoPackage 中的每个矢量要素用户表clause <<feature_user_tables>>)的几何列 都对应 有一行记录。

[requirement]
`gpkg_geometry_columns` 中`table_name` 列的值必须 reference  `gpkg_contents` 中`table_name` 列的值 ，`gpkg_contents` 中`table_name` 列所在的行中，
要带有值为 'features'的`data_type`列。

[requirement]
目前`gpkg_geometry_columns` 中`column_name` 列的值 必须是 某个表或视图中的某一列的列名， 这个表或视图的名字记录在 `table_name` 这一列中。

[requirement]
`gpkg_geometry_columns` 中列`geometry_type_name` 的值必须是附录 <<geometry_types>> 中大写的几何类型名字之一。

[requirement]
在`gpkg_geometry_columns`表中 `srs_id` 值应为 `gpkg_spatial_ref_sys` 表中 `srs_id`  某一列的值。

[requirement]
 `gpkg_geometry_columns` 表中的Z值必须是0, 1或2。 

[requirement]
`gpkg_geometry_columns`表行的m值必须是0, 1或2。 

[[feature_user_tables]]
==== 矢量要素用户数据表

===== 数据

======表定义

:features_data_table_foot2: footnote:[A GeoPackage is not required to contain any feature data tables. Feature data tables in a GeoPackage MAY be empty.]

在GeoPackage文件中，上面的<sfsql_intro>>条款描述的 是SQL schema中描述矢量要素的第三个部分。
要素属性包括几何要素，在表中以列存储。要素在表中以行存储。参见 {features_data_table_foot2}

[[requirement_feature_integer_pk]]

[requirement]
geopackage可以有包含有矢量要素的表或可更新的视图。
在GeoPackage中，每个要素表或视图都必须有一个INTEGER类型的列和 'PRIMARY KEY AUTOINCREMENT' 的列约束，
参见 <<example_feature_table_cols>>和<<example_feature_table_sql>> 。


要素表的 整型主键约束，允许 通过 `gpkg_metadata_reference` 表的
 rowid <<B5>> 值  将要素表中的要素 关联到 `gpkg_metadata`表 行 级别 元数据 记录，在下面的 <<_metadata_reference_table>> 表中进行了描述。

[requirement]
要素表有且仅有一个几何要素列。


按non-GeoPackage 的要素数据模型 <<B23>>，每个要素表可以有多个几何要素列，这种表可以转换为 GeoPackage 的表。每个几何类型对应一个要素表，
要素表的行 需要有符合 整型主键 值，这样他们可以被关联到具有相同列的视图，列的定义在 non-GeoPackage 具有多个几何要素列的矢量数据模型有所描述。

[[example_feature_table_cols]]
.EXAMPLE : Sample Feature Table or View Definition
[cols=",,,,,",options="header"]
|=======================================================================
|Column Name |Type |Description |Null |Default |Key
|`id` |INTEGER |Autoincrement primary key 自动增量主键|no | |PK
|`geometry` |GEOMETRY |GeoPackage Geometry 符合GeoPackage规范的几何要素 |yes | |
|`text_attribute` |TEXT |Text attribute of feature 要素文本属性 |yes | |
|`real_attribute` |REAL |Real attribute of feature 要素实属性|yes | |
|`boolean_attribute` |BOOLEAN |Boolean attribute of feature 要素布尔属性 |yes | |
|`raster_or_photo` |BLOB |Photograph of the area  区域图片|yes | |
|=======================================================================

See <<example_feature_table_sql>>.

====== 表数据值 


按照上面 <<_geometry_columns>> 条款中规定的  `gpkg_geometry_columns` 表 `geometry_column` 值是小写的，矢量要素表中
存储在 几何要素 列中的几何要素要符合这个规定。

要素几何对象列的几何要素类型，要符合 表`gpkg_geometry_columns`中列名为`geometry_type_name` 要求，必须是 <<geometry_types>>中的一个 。


:geom_type_req_foot1: footnote:[GeoPackage applications MAY use SQL triggers or tests in application code to meet this requirement]

[requirement]

几何要素列应该包含几何要素类型或由`gpkg_geometry_columns`表的`geometry_type_name`列的大写值指定的可分配类型 {geom_type_req_foot1}。
  
子几何类型可以被<<geometry_types>> 中定义的类型所限定，部分子几何类型在 <<core_geometry_model_figure>> 中有说明。
例如：如果表`gpkg_geometry_columns`中列 `geometry_type_name` 的值是一种如POINT没有子类型几何类型，这种几何要素表的列可只含有这种类型的几何要素。
如果表`gpkg_geometry_columns` 中`type_name`的值是一种如GEOMCOLLECTION有子类型的几何类型，这种几何要素表的列可以只包含这种类型
或是它的任何直接或间接子类型的几何要素。
如果几何要素的`type_name`值为GEOMETRY （几何类型继承关系的根），这种要素表的几何列可以包含任何类型的几何要素。

几何要素存在或不存在可选的高程（Z）和/或测量（M）值不会改变它的类型或类型的相关限制。


几何要素的空间参考系统类型是由`gpkg_geometry_columns` 表中的`srs_id`列的值限定的，
`srs_id`的值是来自表`gpkg_spatial_ref_sys` 的`srs_id`列值中的一个代码。

[requirement]
Feature table geometry columns SHALL contain geometries with the `srs_id` specified for the column by the `gpkg_geometry_columns` table `srs_id` column value.
要素表的几何要素列应该包含 有 `srs_id` 的几何要素，  `srs_id` 列值必须是表`gpkg_geometry_columns` 的 `srs_id` 列值。
